// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  // output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------------------------
// ENUMS
// ---------------------------

enum StatutDemande {
  EN_ATTENTE
  APPROUVEE
  REFUSEE
}

enum RolePersonnel {
  ADMIN
  RH
  CHEF_SERVICE
  EMPLOYE
}

enum TypePersonnel {
  PERMANENT
  CONTRACTUEL
  STAGIAIRE
}

// ---------------------------
// MODELES PRINCIPAUX
// ---------------------------

model Direction {
  id_direction    String    @id @default(uuid())
  code_direction  String    @unique
  nom_direction   String
  nb_personnel    Int?      @default(0)
  nom_directeur   String
  email_direction String?
  statut          String?   @default("ACTIF")
  date_creation   DateTime  @default(now())

  services        Service[]

  @@map("directions")
}

model Service {
  id_service     String    @id @default(uuid())
  code_service   String    @unique
  nom_service    String
  nb_personnel   Int?      @default(0)
  date_creation  DateTime  @default(now())
  id_direction   String

  direction      Direction @relation(fields: [id_direction], references: [id_direction])
  personnels     Personnel[]
  demandes       Demande[]

  @@map("services")
}

model Personnel {
  id_personnel            String   @id @default(uuid())
  nom_personnel           String
  prenom_personnel        String
  email_personnel         String?  @unique
  email_travail           String?  @unique
  password                String?  // Mot de passe hashé
  date_naissance          DateTime?
  matricule_personnel     String?  @unique
  telephone_travail       String?
  telephone_personnel     String?
  ville_personnel         String?
  adresse_personnel       String?
  codepostal              String?
  pays_personnel          String?
  telephone_contact_urgence String?
  nom_contact_urgence     String?
  role_personnel          RolePersonnel @default(EMPLOYE)
  type_personnel          TypePersonnel @default(PERMANENT)
  date_creation           DateTime @default(now())
  id_service              String
  is_active               Boolean  @default(true)

  service                 Service   @relation(fields: [id_service], references: [id_service])
  demandes                Demande[]
  fichesConge             FicheDeConge[]
  // Si c'est un chef de service, il peut avoir des demandes à approuver
  demandesEnCoursChef     Demande[] @relation("ChefDemande")

  @@map("personnels")
}

model TypeConge {
  id_typeconge     String   @id @default(uuid())
  libelle_typeconge String  @unique
  date_creation    DateTime @default(now())
  is_active        Boolean  @default(true)

  periodesConge    PeriodeConge[]

  @@map("types_conge")
}

model PeriodeConge {
  id_periodeconge  String   @id @default(uuid())
  date_debut       DateTime
  date_fin         DateTime
  nb_jour          Int
  id_typeconge     String

  typeConge        TypeConge @relation(fields: [id_typeconge], references: [id_typeconge])
  demandes         Demande[]

  @@map("periodes_conge")
}

model Demande {
  id_demande       String          @id @default(uuid())
  type_demande     String
  statut_demande   StatutDemande   @default(EN_ATTENTE)
  date_demande     DateTime        @default(now())
  motif            String?
  id_personnel     String
  id_service       String?
  id_periodeconge  String?
  id_chef_service  String?         // Chef de service responsable

  personnel        Personnel   @relation(fields: [id_personnel], references: [id_personnel])
  service          Service?    @relation(fields: [id_service], references: [id_service])
  periodeConge     PeriodeConge? @relation(fields: [id_periodeconge], references: [id_periodeconge])
  discussions      Discussion[]
  // Chef de service responsable de cette demande
  chefService      Personnel?  @relation("ChefDemande", fields: [id_chef_service], references: [id_personnel])
  ficheDeConge     FicheDeConge?

  @@map("demandes")
}

model Discussion {
  id_discussion    String   @id @default(uuid())
  message          String
  date_message     DateTime @default(now())
  heure_message    String?
  id_demande       String

  demande          Demande  @relation(fields: [id_demande], references: [id_demande])

  @@map("discussions")
}

model FicheDeConge {
  id_ficheconge    String   @id @default(uuid())
  message          String?
  date_message     DateTime @default(now())
  heure_message    String?
  id_demande       String   @unique
  id_personnel     String

  demande          Demande   @relation(fields: [id_demande], references: [id_demande])
  personnel        Personnel @relation(fields: [id_personnel], references: [id_personnel])

  @@map("fiches_conge")
}
